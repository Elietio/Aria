<ui:FluentWindow x:Class="ScreenBridge.App.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
        xmlns:tb="http://www.hardcodet.net/taskbar"
        xmlns:local="clr-namespace:ScreenBridge.App"
        mc:Ignorable="d"
        Title="ScreenBridge" 
        Height="Auto" Width="800"
        MinHeight="500" MinWidth="700"
        SizeToContent="Height" ResizeMode="CanResize"
        WindowStartupLocation="CenterScreen"
        ExtendsContentIntoTitleBar="True"
        WindowBackdropType="Mica"
        Background="Transparent"
        StateChanged="FluentWindow_StateChanged">

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- Layer 0: Ambient Glow (Spans All Rows) -->
        <!-- Layer 0: Ambient Glow (Radial Only - Cleaner) -->
        <Border x:Name="AmbientGlow" Grid.RowSpan="2" Opacity="0.6">
            <Border.Background>
                <RadialGradientBrush GradientOrigin="0.5,0.5" Center="0.5,0.5" RadiusX="0.8" RadiusY="0.8">
                    <GradientStop x:Name="AmbientGlowInner" Color="#00BFFF" Offset="0"/>
                    <GradientStop Color="Transparent" Offset="1"/>
                </RadialGradientBrush>
            </Border.Background>
        </Border>

        <!-- Layer 1: Mascot (Spans All Rows, Bottom Left) -->
        <!-- Note: Using JPG placeholders for now, opacity reduced to blend -->
        <Image x:Name="MascotImage" Grid.RowSpan="2" 
               HorizontalAlignment="Left" VerticalAlignment="Bottom" 
               Height="600" Stretch="Uniform" Opacity="0.9" Margin="-100,0,0,-50"
               RenderOptions.BitmapScalingMode="HighQuality"
               IsHitTestVisible="False"/>

        <!-- 标题栏 -->
        <ui:TitleBar Grid.Row="0" Title="ScreenBridge" ShowMaximize="True" ShowMinimize="True"/>

        <!-- 主内容区域 -->
        <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Disabled">
            <Grid Margin="24" VerticalAlignment="Top">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>
                
                <!-- BackgroundWatermark 已移除，使用 Mica 材质 -->

            <!-- 当前模式状态卡片 -->
            <ui:Card x:Name="ModeStatusCard" Grid.Row="0" Margin="0,0,0,24" Padding="24" HorizontalAlignment="Stretch">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>

                    <!-- 头像区域 -->
                    <Border Grid.Column="0" 
                            x:Name="ModeIconBorder"
                            Width="80" Height="80" 
                            CornerRadius="40" 
                            Background="#10FFFFFF"
                            Margin="0,0,24,0"
                            VerticalAlignment="Top"
                            MouseLeftButtonDown="ModeIcon_MouseLeftButtonDown"
                            Cursor="Hand">
                        <Border.Effect>
                            <DropShadowEffect Color="Black" Opacity="0.15" BlurRadius="10" ShadowDepth="4" Direction="270"/>
                        </Border.Effect>
                        <Grid>
                            <ui:SymbolIcon x:Name="ModeIcon" 
                                           Symbol="Desktop24"
                                           FontSize="32"
                                           Foreground="Gray"/>
                            <Image x:Name="ModeImage" Visibility="Collapsed" Stretch="UniformToFill"
                                   RenderOptions.BitmapScalingMode="HighQuality">
                                <Image.Clip>
                                    <EllipseGeometry Center="40,40" RadiusX="40" RadiusY="40"/>
                                </Image.Clip>
                            </Image>
                        </Grid>
                    </Border>

                    <!-- 文本区域 -->
                    <StackPanel Grid.Column="1" VerticalAlignment="Center">
                        <TextBlock x:Name="ModeTitle" Text="Windows 模式" FontSize="26" FontWeight="SemiBold" Margin="0,0,0,4"/>
                        <TextBlock x:Name="ModeDescription" Text="主显示器用于 Windows，音频输出到主显示器" 
                                   Foreground="{ui:ThemeResource TextFillColorSecondaryBrush}" 
                                   FontSize="14"
                                   Margin="0,0,0,8"/>
                        
                        <!-- 状态标签 -->
                        <Border HorizontalAlignment="Left" Background="#20FFFFFF" CornerRadius="4" Padding="8,4">
                            <TextBlock x:Name="WindowRuleStatus" Text="窗口规则: 默认" 
                                       FontSize="12"
                                       Foreground="{ui:ThemeResource TextFillColorTertiaryBrush}"/>
                        </Border>
                    </StackPanel>

                    <!-- 按钮区域 -->
                    <StackPanel Grid.Column="2" VerticalAlignment="Center" Margin="16,0,0,0">
                        <ui:Button x:Name="SwitchModeButton"
                                   Content="切换模式" 
                                   Appearance="Primary"
                                   Click="SwitchModeButton_Click"
                                   Width="160" Height="40" FontSize="14" Margin="0,0,0,12"/>

                        <ui:Button Content="打开窗口概览" 
                                   Appearance="Secondary"
                                   Click="OpenOverviewButton_Click"
                                   Width="160" Height="40">
                            <ui:Button.Icon>
                                <ui:SymbolIcon Symbol="WindowApps24"/>
                            </ui:Button.Icon>
                        </ui:Button>
                    </StackPanel>
                </Grid>
            </ui:Card>

            <!-- 音频设备设置 -->
            <ui:Card x:Name="AudioSettingsCard" Grid.Row="1" Margin="0,0,0,20" Padding="24">
                <StackPanel>
                    <TextBlock Text="音频设置" FontSize="16" FontWeight="SemiBold" Margin="0,0,0,16"/>
                    
                    <!-- 当前活动设备 (可切换) -->
                    <Grid Margin="0,0,0,16">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        <ui:SymbolIcon Symbol="Speaker224" FontSize="20" Margin="0,0,12,0" VerticalAlignment="Center"/>
                        
                        <ComboBox Grid.Column="1" x:Name="AudioDeviceComboBox" 
                                     DisplayMemberPath="Name" SelectedValuePath="Id"
                                     SelectionChanged="AudioDeviceComboBox_SelectionChanged"
                                     HorizontalAlignment="Stretch"/>
                    </Grid>

                    <!-- 音量滑块 -->
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="40"/>
                        </Grid.ColumnDefinitions>
                        <ui:SymbolIcon Symbol="Speaker224" FontSize="20" Margin="0,0,12,0" VerticalAlignment="Center" Visibility="Hidden"/> <!-- 占位 -->
                        
                        <Slider Grid.Column="1" x:Name="VolumeSlider" 
                                Minimum="0" Maximum="100" 
                                IsMoveToPointEnabled="True"
                                TickFrequency="1"
                                VerticalAlignment="Center"
                                ValueChanged="VolumeSlider_ValueChanged"/>
                        
                        <TextBlock Grid.Column="2" x:Name="VolumeText" 
                                   Text="0%" 
                                   HorizontalAlignment="Right"
                                   VerticalAlignment="Center"
                                   Foreground="{ui:ThemeResource TextFillColorSecondaryBrush}"/>
                    </Grid>
                </StackPanel>
            </ui:Card>

            <!-- 热键设置 -->
            <ui:Card x:Name="HotkeySettingsCard" Grid.Row="2" Margin="0,0,0,20" Padding="24">
                <StackPanel>
                    <TextBlock Text="快捷键" FontSize="16" FontWeight="SemiBold" Margin="0,0,0,16"/>
                    
                    <Grid Margin="0,0,0,12">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        <TextBlock Text="切换模式" VerticalAlignment="Center" Width="80" Foreground="{ui:ThemeResource TextFillColorSecondaryBrush}"/>
                        <ui:TextBox Grid.Column="1" x:Name="SwitchHotkeyTextBox" 
                                    Text="Ctrl + Alt + S" IsReadOnly="True"/>
                    </Grid>
                    
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        <TextBlock Text="窗口概览" VerticalAlignment="Center" Width="80" Foreground="{ui:ThemeResource TextFillColorSecondaryBrush}"/>
                        <ui:TextBox Grid.Column="1" x:Name="OverviewHotkeyTextBox" 
                                    Text="Ctrl + Alt + W" IsReadOnly="True"/>
                    </Grid>
                </StackPanel>
            </ui:Card>

            <!-- 显示器信息 -->
            <ui:Card x:Name="MonitorInfoCard" Grid.Row="3" Margin="0,0,0,20" Padding="24">
                <StackPanel>
                    <TextBlock Text="显示器信息" FontSize="16" FontWeight="SemiBold" Margin="0,0,0,16"/>
                    <StackPanel x:Name="MonitorInfoPanel">
                        <!-- 动态生成 -->
                    </StackPanel>
                </StackPanel>
            </ui:Card>

            <!-- 底部设置与规则按钮 -->
            <Grid Grid.Row="4" Margin="0,16,0,0">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                
                <StackPanel Grid.Column="0" Orientation="Horizontal" VerticalAlignment="Center">
                    <ui:ToggleSwitch x:Name="AutoStartToggle" Content="开机自启动" Margin="0,0,24,0" 
                                     Checked="AutoStartToggle_Checked" Unchecked="AutoStartToggle_Unchecked"/>
                    <ui:ToggleSwitch x:Name="DDCAutoDetectToggle" Content="DDC/CI 自动检测" 
                                     Checked="DDCAutoDetectToggle_Checked" Unchecked="DDCAutoDetectToggle_Unchecked"/>
                </StackPanel>

                <ui:Button Grid.Column="1" Content="配置规则..." Appearance="Secondary" 
                           Click="ConfigureRulesButton_Click">
                    <ui:Button.Icon>
                        <ui:SymbolIcon Symbol="Settings24"/>
                    </ui:Button.Icon>
                </ui:Button>
            </Grid>
        </Grid>
        
        <!-- 系统托盘图标 -->

        </ScrollViewer>

        <!-- Layer 4: Dialogue Bubble (Floating above content - Aligned to Avatar) -->
        <Border x:Name="DialogueBubble" Grid.RowSpan="2" 
                HorizontalAlignment="Left" VerticalAlignment="Top"
                Margin="130,110,0,0" 
                Padding="16,12"
                CornerRadius="16"
                Background="#E6FFFFFF"
                BorderBrush="#20000000" BorderThickness="1"
                Visibility="Collapsed"
                IsHitTestVisible="False">
            <Border.Effect>
                <DropShadowEffect Color="Black" Opacity="0.1" BlurRadius="8" ShadowDepth="2"/>
            </Border.Effect>
            <Grid>
                <!-- 小尾巴 (Triangle) - Simplified as a Polygon is tricky in Border, simply using bubble shape for now -->
                <TextBlock x:Name="DialogueText" 
                           Text="Hello World!" 
                           FontSize="14" 
                           Foreground="#333"
                           TextWrapping="Wrap" 
                           MaxWidth="220"/>
            </Grid>
        </Border>

        <tb:TaskbarIcon x:Name="TrayIcon"
                        ToolTipText="ScreenBridge"
                        TrayLeftMouseDoubleClick="TrayShow_Click">
            <tb:TaskbarIcon.ContextMenu>
                <ContextMenu>
                    <MenuItem Header="📺 显示主窗口" Click="TrayShow_Click"/>
                    <Separator/>
                    <MenuItem Header="🖥️ 切换到 Windows 模式" Click="TrayWindowsMode_Click"/>
                    <MenuItem Header="🎮 切换到 PS5 模式" Click="TrayPS5Mode_Click"/>
                    <Separator/>
                    <MenuItem Header="❌ 退出" Click="TrayExit_Click"/>
                </ContextMenu>
            </tb:TaskbarIcon.ContextMenu>
        </tb:TaskbarIcon>
    </Grid>
</ui:FluentWindow>
